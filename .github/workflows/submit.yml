name: RSA-Challenge-Submit

on:
  repository_dispatch:
    types: [rsa-submit]

permissions:
  contents: write
  issues: write

env:
  GH_PAT: ${{ secrets.GH_PAT }}   # <-- Inject your token here

jobs:
  handle:
    runs-on: ubuntu-latest
    steps:
    - name: Process submission
      uses: actions/github-script@v7
      with:
        script: |
          const token = process.env.GH_PAT;
          const payload = context.payload.client_payload;

          const issueTitle = `Challenge ${payload.name}`;
          const body = `RSA Challenge leaderboard for **${payload.name}**`;

          // Authenticate manually using your PAT
          const octokit = new github.constructor({
            auth: token
          });

          // Check if issue exists
          const issues = await octokit.rest.issues.listForRepo({
            owner: "Abhrankan-Chakrabarti",
            repo: "rsa-challenge-site",
            state: "open"
          });

          let issue = issues.data.find(i => i.title === issueTitle);

          if (!issue) {
            const newIssue = await octokit.rest.issues.create({
              owner: "Abhrankan-Chakrabarti",
              repo: "rsa-challenge-site",
              title: issueTitle,
              body
            });
            issue = newIssue.data;
          }

          // Add leaderboard entry
          await octokit.rest.issues.createComment({
            owner: "Abhrankan-Chakrabarti",
            repo: "rsa-challenge-site",
            issue_number: issue.number,
            body: `ðŸ‘¤ **${payload.user}** submitted:\n\n\`${payload.guess}\`\n\nSHA256: \`${payload.sha256}\``
          });

          return "OK";